FROM bitwalker/alpine-elixir-phoenix:1.14 AS builder

WORKDIR /app

COPY ../dev.env ./.env

RUN RUN export $(cat ./.env | xargs) \
    apk --no-cache --update add alpine-sdk gmp-dev automake libtool inotify-tools autoconf python3 file qemu-x86_64 

ENV GLIBC_REPO=https://github.com/sgerrand/alpine-pkg-glibc \
    GLIBC_VERSION=2.30-r0 \
    PORT=4000 \
    MIX_ENV="prod" \
    SECRET_KEY_BASE="RMgI4C1HSkxsEjdhtGMfwAHfyT6CKWXOgzCboJflfSm4jeAlic52io05KB6mqzc5" \
    COIN="" \
    CACHE_EXCHANGE_RATES_PERIOD="" \
    API_V1_READ_METHODS_DISABLED="false" \
    DISABLE_WEBAPP="false" \
    API_V1_WRITE_METHODS_DISABLED="false" \
    CACHE_TOTAL_GAS_USAGE_COUNTER_ENABLED="" \
    CACHE_ADDRESS_WITH_BALANCES_UPDATE_INTERVAL="" \
    ADMIN_PANEL_ENABLED="" \
    RELEASE_VERSION=5.1.4 \
    MIX_ENV=prod \
    ETHEREUM_JSONRPC_VARIANT=${ETHEREUM_JSONRPC_VARIANT:-} \
    ETHEREUM_JSONRPC_HTTP_URL=${ETHEREUM_JSONRPC_HTTP_URL:-} \
    DATABASE_URL=${DATABASE_URL:-} \
    ETHEREUM_JSONRPC_TRACE_URL=${ETHEREUM_JSONRPC_TRACE_URL:-} \
    NETWORK=${NETWORK:-} \
    SUBNETWORK=${SUBNETWORK:-} \
    LOGO=${LOGO:-} \
    LOGO_FOOTER=${LOGO_FOOTER:-} \
    ETHEREUM_JSONRPC_WS_URL=${ETHEREUM_JSONRPC_WS_URL:-} \
    ETHEREUM_JSONRPC_TRANSPORT=${ETHEREUM_JSONRPC_TRANSPORT:-} \
    IPC_PATH=${IPC_PATH:-} \
    NETWORK_PATH=${NETWORK_PATH:-} \
    API_PATH=${API_PATH:-} \
    SOCKET_ROOT=${SOCKET_ROOT:-} \
    BLOCKSCOUT_HOST=${BLOCKSCOUT_HOST:-} \
    BLOCKSCOUT_PROTOCOL=${BLOCKSCOUT_PROTOCOL:-} \
    SECRET_KEY_BASE=${SECRET_KEY_BASE:-} \
    CHECK_ORIGIN=${CHECK_ORIGIN:-} \
    PORT=${PORT:-} \
    COIN=${COIN:-} \
    COIN_NAME=${COIN_NAME:-} \
    COINGECKO_COIN_ID=${COINGECKO_COIN_ID:-} \
    METADATA_CONTRACT=${METADATA_CONTRACT:-} \
    VALIDATORS_CONTRACT=${VALIDATORS_CONTRACT:-} \
    KEYS_MANAGER_CONTRACT=${KEYS_MANAGER_CONTRACT:-} \
    REWARDS_CONTRACT=${REWARDS_CONTRACT:-} \
    TOKEN_BRIDGE_CONTRACT=${TOKEN_BRIDGE_CONTRACT:-} \
    EMISSION_FORMAT=${EMISSION_FORMAT:-} \
    CHAIN_SPEC_PATH=${CHAIN_SPEC_PATH:-} \
    SUPPLY_MODULE=${SUPPLY_MODULE:-} \
    SOURCE_MODULE=${SOURCE_MODULE:-} \
    POOL_SIZE=${POOL_SIZE:-} \
    POOL_SIZE_API=${POOL_SIZE_API:-} \
    ECTO_USE_SSL=${ECTO_USE_SSL:-} \
    DATADOG_HOST=${DATADOG_HOST:-} \
    DATADOG_PORT=${DATADOG_PORT:-} \
    SPANDEX_BATCH_SIZE=${SPANDEX_BATCH_SIZE:-} \
    SPANDEX_SYNC_THRESHOLD=${SPANDEX_SYNC_THRESHOLD:-} \
    HEART_BEAT_TIMEOUT=${HEART_BEAT_TIMEOUT:-} \
    HEART_COMMAND=${HEART_COMMAND:-} \
    BLOCKSCOUT_VERSION=${BLOCKSCOUT_VERSION:-} \
    RELEASE_LINK=${RELEASE_LINK:-} \
    BLOCK_TRANSFORMER=${BLOCK_TRANSFORMER:-} \
    GRAPHIQL_TRANSACTION=${GRAPHIQL_TRANSACTION:-} \
    FIRST_BLOCK=${FIRST_BLOCK:-} \
    LAST_BLOCK=${LAST_BLOCK:-} \
    TRACE_FIRST_BLOCK=${TRACE_FIRST_BLOCK:-} \
    TRACE_LAST_BLOCK=${TRACE_LAST_BLOCK:-} \
    LINK_TO_OTHER_EXPLORERS=${LINK_TO_OTHER_EXPLORERS:-} \
    OTHER_EXPLORERS=${OTHER_EXPLORERS:-} \
    SUPPORTED_CHAINS=${SUPPORTED_CHAINS:-} \
    CACHE_BLOCK_COUNT_PERIOD=${CACHE_BLOCK_COUNT_PERIOD:-} \
    CACHE_TXS_COUNT_PERIOD=${CACHE_TXS_COUNT_PERIOD:-} \
    CACHE_ADDRESS_COUNT_PERIOD=${CACHE_ADDRESS_COUNT_PERIOD:-} \
    CACHE_ADDRESS_SUM_PERIOD=${CACHE_ADDRESS_SUM_PERIOD:-} \
    CACHE_TOTAL_GAS_USAGE_PERIOD=${CACHE_TOTAL_GAS_USAGE_PERIOD:-} \
    CACHE_ADDRESS_TRANSACTIONS_GAS_USAGE_COUNTER_PERIOD=${CACHE_ADDRESS_TRANSACTIONS_GAS_USAGE_COUNTER_PERIOD:-} \
    CACHE_TOKEN_HOLDERS_COUNTER_PERIOD=${CACHE_TOKEN_HOLDERS_COUNTER_PERIOD:-} \
    CACHE_TOKEN_TRANSFERS_COUNTER_PERIOD=${CACHE_TOKEN_TRANSFERS_COUNTER_PERIOD:-} \
    CACHE_ADDRESS_WITH_BALANCES_UPDATE_INTERVAL=${CACHE_ADDRESS_WITH_BALANCES_UPDATE_INTERVAL:-} \
    CACHE_AVERAGE_BLOCK_PERIOD=${CACHE_AVERAGE_BLOCK_PERIOD:-} \
    CACHE_MARKET_HISTORY_PERIOD=${CACHE_MARKET_HISTORY_PERIOD:-} \
    CACHE_ADDRESS_TRANSACTIONS_PERIOD=${CACHE_ADDRESS_TRANSACTIONS_PERIOD:-} \
    CACHE_ADDRESS_TOKENS_USD_SUM_PERIOD=${CACHE_ADDRESS_TOKENS_USD_SUM_PERIOD:-} \
    CACHE_ADDRESS_TOKEN_TRANSFERS_COUNTER_PERIOD=${CACHE_ADDRESS_TOKEN_TRANSFERS_COUNTER_PERIOD:-} \
    CACHE_BRIDGE_MARKET_CAP_UPDATE_INTERVAL=${CACHE_BRIDGE_MARKET_CAP_UPDATE_INTERVAL:-} \
    CACHE_TOKEN_EXCHANGE_RATE_PERIOD=${CACHE_TOKEN_EXCHANGE_RATE_PERIOD:-} \
    TOKEN_METADATA_UPDATE_INTERVAL=${TOKEN_METADATA_UPDATE_INTERVAL:-} \
    ALLOWED_EVM_VERSIONS=${ALLOWED_EVM_VERSIONS:-} \
    UNCLES_IN_AVERAGE_BLOCK_TIME=${UNCLES_IN_AVERAGE_BLOCK_TIME:-} \
    DISABLE_WEBAPP=${DISABLE_WEBAPP:-} \
    DISABLE_READ_API=${DISABLE_READ_API:-} \
    DISABLE_WRITE_API=${DISABLE_WRITE_API:-} \
    DISABLE_INDEXER=${DISABLE_INDEXER:-} \
    INDEXER_DISABLE_PENDING_TRANSACTIONS_FETCHER=${INDEXER_DISABLE_PENDING_TRANSACTIONS_FETCHER:-} \
    INDEXER_DISABLE_INTERNAL_TRANSACTIONS_FETCHER=${INDEXER_DISABLE_INTERNAL_TRANSACTIONS_FETCHER:-} \
    WEBAPP_URL=${WEBAPP_URL:-} \
    API_URL=${API_URL:-} \
    WOBSERVER_ENABLED=${WOBSERVER_ENABLED:-} \
    SHOW_ADDRESS_MARKETCAP_PERCENTAGE=${SHOW_ADDRESS_MARKETCAP_PERCENTAGE:-} \
    CHECKSUM_ADDRESS_HASHES=${CHECKSUM_ADDRESS_HASHES:-} \
    CHECKSUM_FUNCTION=${CHECKSUM_FUNCTION:-} \
    DISABLE_EXCHANGE_RATES=${DISABLE_EXCHANGE_RATES:-} \
    DISABLE_KNOWN_TOKENS=${DISABLE_KNOWN_TOKENS:-} \
    ENABLE_TXS_STATS=${ENABLE_TXS_STATS:-} \
    SHOW_PRICE_CHART=${SHOW_PRICE_CHART:-} \
    SHOW_TXS_CHART=${SHOW_TXS_CHART:-} \
    HISTORY_FETCH_INTERVAL=${HISTORY_FETCH_INTERVAL:-}


RUN set -ex && \
    apk --update add libstdc++ curl ca-certificates && \
    for pkg in glibc-${GLIBC_VERSION} glibc-bin-${GLIBC_VERSION}; \
        do curl -sSL ${GLIBC_REPO}/releases/download/${GLIBC_VERSION}/${pkg}.apk -o /tmp/${pkg}.apk; done && \
    apk add --allow-untrusted /tmp/*.apk && \
    rm -v /tmp/*.apk && \
    /usr/glibc-compat/sbin/ldconfig /lib /usr/glibc-compat/lib

# Get Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y

ENV PATH="$HOME/.cargo/bin:${PATH}"
ENV RUSTFLAGS="-C target-feature=-crt-static"

ARG CACHE_EXCHANGE_RATES_PERIOD
ARG DISABLE_READ_API
ARG DISABLE_WEBAPP
ARG DISABLE_WRITE_API
ARG CACHE_TOTAL_GAS_USAGE_COUNTER_ENABLED
ARG ADMIN_PANEL_ENABLED
ARG CACHE_ADDRESS_WITH_BALANCES_UPDATE_INTERVAL
ARG SESSION_COOKIE_DOMAIN
ARG MIXPANEL_TOKEN
ARG MIXPANEL_URL
ARG AMPLITUDE_API_KEY
ARG AMPLITUDE_URL

# Cache elixir deps
ADD mix.exs mix.lock ./
ADD apps/block_scout_web/mix.exs ./apps/block_scout_web/
ADD apps/explorer/mix.exs ./apps/explorer/
ADD apps/ethereum_jsonrpc/mix.exs ./apps/ethereum_jsonrpc/
ADD apps/indexer/mix.exs ./apps/indexer/

RUN mix do deps.get, local.rebar --force, deps.compile

ADD . .

COPY . .

# Run forderground build and phoenix digest
RUN mix compile && npm install npm@latest

# Add blockscout npm deps
RUN cd apps/block_scout_web/assets/ && \
    npm install && \
    npm run deploy && \
    cd /app/apps/explorer/ && \
    npm install && \
    apk update && \
    apk del --force-broken-world alpine-sdk gmp-dev automake libtool inotify-tools autoconf python3

RUN mix phx.digest

RUN mkdir -p /opt/release \
  && mix release blockscout \
  && mv _build/${MIX_ENV}/rel/blockscout /opt/release

##############################################################
FROM bitwalker/alpine-elixir-phoenix:1.14

ARG RELEASE_VERSION
ENV RELEASE_VERSION=${RELEASE_VERSION}
ARG BLOCKSCOUT_VERSION
ENV BLOCKSCOUT_VERSION=${BLOCKSCOUT_VERSION}

RUN apk --no-cache --update add jq

WORKDIR /app

COPY --from=builder /opt/release/blockscout .
COPY --from=builder /app/apps/explorer/node_modules ./node_modules
COPY --from=builder /app/config/config_helper.exs ./config/config_helper.exs
COPY --from=builder /app/config/config_helper.exs /app/releases/${RELEASE_VERSION}/config_helper.exs

